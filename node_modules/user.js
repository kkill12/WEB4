var Q = require('q');
var db = require('db');
var content = require('content');

//构造函数
function user(){

}
//SQL语句
var sqlstr={
}
//公共值
var conn = null;
var colname = null;
var tabledata = null;
var listdata = null;
var rowdata = null;

//函数集合
var fun = {
	getCol:function(tablename){
		console.log('getCol comming.........'+content._COLSQL);
		//注意函数的准确用法
		var defer = Q.defer();

		//取出本表所有存在的字段
		conn.query(content._COLSQL,tablename,function(err,data){
			if(err){
				defer.reject(err);
			}else{
				//数据库字符串转换成
				colname = content.tArr(data);
				tabledata = content.tCol(data);
				console.log();
				defer.resolve();
			}
		});
		return defer.promise;
	},
	insert:function(){
		console.log('inser comming ........');
		var defer = Q.defer();
		//回调函数+唤醒
		conn.query('INSERT INTO PMS_USERS SET  ?',rowdata,function(err,result){
			if(err){
				defer.reject(err);
			}else{

				defer.resolve(result);
			}
		});
		return defer.promise;
	},
	update:function(){
		console.log('update comming .......');
		var defer = Q.defer();
		rowdata = {username:'kangsiyuan'};
		conn.query('UPDATE PMS_USERS SET ? WHERE USERID="5"',rowdata,function(err,result){
			if(err){
				defer.reject(err);
			}else{
				defer.resolve(result);
			}
		});
		return defer.promise;
	},
	delete:function(){
		console.log('delete comming .......');
		var defer = Q.defer();
		par = {userid:'1',username:'kangyun'};
		conn.query('DELETE FROM PMS_USERS WHERE userid=? and username=?',['1','kangyun'],function(err,result){
			if(err){
				defer.reject(err);
			}else{
				defer.resolve(result);
			}			
		});
		return defer.promise;
	}
}

db.getConnection(function(err,thconn){
	console.log(err);
	conn =thconn;
	data = {username:'kangyun',userid:'9'};
	rowdata = data;
	fun['getCol']('PMS_USERS')
		.then(fun['delete'])
		.done(function(suc){
			conn.release();
			console.log('oper success');
		},function(err){
			console.log(err);
	});
});

